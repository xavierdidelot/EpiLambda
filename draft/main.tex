\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[top=3cm, bottom=3cm, left=3cm,right=3cm]{geometry}
%\usepackage[numbers,round]{natbib}
\usepackage{natbib}
\setcitestyle{aysep={}} 
\usepackage{graphicx}
\usepackage{color}
\usepackage{amsfonts, amsmath}
\usepackage{setspace}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{bbm}
\usepackage{float}
\usepackage{hyperref}
\usepackage[super]{nth}

\parindent0cm
\parskip0.5cm
\hyphenpenalty=10000
\pretolerance=10000
\usepackage{lineno}

% Line numbering works around align environment without requiring paragraph break
\let\oldalign\align
\let\oldendalign\endalign
\renewenvironment{align}{\linenomathNonumbers\oldalign}{\oldendalign\endlinenomath}

\linenumbers

\makeatletter
\newcommand{\customlabel}[2]{
\protected@write \@auxout {}{\string \newlabel {#1}{{#2}{}}}}
\makeatother

%\renewcommand\footnote[2][]{\relax}

\begin{document}
{\Large Ancestral process for infectious disease outbreaks with superspreading}

%Journal target:  Journal of Theoretical Biology? Theoretical Population Biology?

\vspace*{2cm}
Xavier Didelot$^{1,2,*}$, David Helekal$^{3}$, Ian Roberts$^{2}$, ...

\vspace*{2cm}
$^1$ School of Life Sciences, University of Warwick, Coventry, United Kingdom\\\\
$^2$ Department of Statistics, University of Warwick, Coventry, United Kingdom\\\\
$^3$ Department of Immunology and Infectious Diseases, Harvard T. H. Chan School of Public Health, Boston, Massachusetts, USA\\\\
$^*$ Corresponding author. Tel: 0044 (0)2476 572827. Email: \verb+xavier.didelot@gmail.com+

\vspace*{2cm}
Running title: Ancestry for outbreaks with superspreading

\vspace*{2cm}
Keywords: infectious disease epidemiology modelling; offspring distribution; superspreading; outbreaks; lambda-coalescent model; multiple mergers

%\newpage
%\section*{Abstract}
%TODO

\newpage
\section{Introduction}

An outbreak of an infectious disease typically starts when a single or a small number
of infected individuals appear within a susceptible population. Each infected individual
may come in contact and infected each of the susceptible individuals, who will then
become infected in their turn and spread the disease further. Most infectious disease
modelling theory describes situations where the disease is at an equilibrium, when the number
of infected individuals is high and/or with a significant part of the population already infected
\citep{Anderson1991,keeling2008modeling}. 
Here however we focus on the early stages of an epidemic, where the number of 
infected individuals is small and the number of susceptibles relatively high and unchanging.
In this situation it is useful to think about the number of infections that each newly infected
individual is likely to cause, and the probabilistic distribution for this number is often called
the offspring distribution \citep{Grassly2008}. 
The mean of the offspring distribution is called the basic
reproduction number $R_0$ and has been given much attention especially since
it determines how likely the outbreak is to spread, and how much effort would be needed
to bring it under control \citep{fraserFactorsThatMake2004,fergusonStrategiesMitigatingInfluenza2006}. 

If we consider that all
individuals are infectious for the same duration and with the same infectiousness,
the offspring distribution is Poisson distributed with mean $R_0$, which means that the variance
of the offspring distribution is also $R_0$. We would then say that there is no transmission
heterogeneity. However, in practice there are many reasons why this may not be the case,
with some individuals being infectious for longer, or being more infectious than others, or 
having more contacts with susceptibles, or being less symptomatic and therefore less likely
to reduce contact numbers, etc. All these factors cause the offspring distribution to be more 
dispersed than it would otherwise be, that is to have a variance greater than its mean $R_0$. 
A frequent choice to capture this overdispersion is to model the offspring distribution
using a Negative-Binomial distribution with mean $R_0$ and dispersion parameter $r$
\citep{Lloyd-Smith2005,Grassly2008}. When $r$ is close to zero the variance is high compared to the mean,
whereas when $r$ is high the variance becomes close to the mean. This transmission heterogeneity
is often called superspreading, although this is perhaps misleading
as it is the rule rather than the exception of how infectious diseases spread. Superspreading has
indeed been described in many diseases \citep{woolhouseHeterogeneitiesTransmissionInfectious1997,
steinSuperspreadersInfectiousDiseases2011,kucharskiRoleSuperspreadingMiddle2015,
wangSuperspreadingHeterogeneityTransmission2021}, 
and most recently for 
SARS-CoV-2 \citep{Wang2020,lemieuxPhylogeneticAnalysisSARSCoV22021,gomez-carballaSuperspreadingEmergenceCOVID192021,duSystematicReviewMetaanalyses2022}.

As an outbreak unfolds forward-in-time, a transmission tree is generated representing who-infected-whom,
in which each node is an infected individual and points towards a number of nodes distributed according
to the offspring distribution. Here we consider the reverse problem of the transmission ancestry, going backward-in-time, from a sample of infected individuals, until reaching the last common 
transmission ancestor of the whole sample. Given a sample of $n$ sampled individuals,
we show how to calculate the probability that a given subset of size $k$ have the same infector,
either inclusively (so that the remaining $n-k$ may also have the same infector or not)
or exclusively (so that none of the remaining $n-k$ have the same infector). We start
by considering the general case of an offspring distribution with arbitrary form, 
and then the specific cases of 
offspring distributions that follow a Poisson or a Negative-Binomial distribution.
The main novelty of our approach is that we consider that the overall population size is small,
but we show that if the population size is large, our results agree with several previous
studies \citep{Volz2012a,koelleRatesCoalescenceCommon2012,Fraser2017}.
Finally, we show how our results can be incorporated into a new lambda-coalescent model 
\citep{pitmanCoalescentsMultipleCollisions1999,sagitovGeneralCoalescentAsynchronous1999,
donnellyParticleRepresentationsMeasureValued1999} and compare it with previously
described models.

\section{General case}

Let time be measured in discrete units and denoted $t$. Each discrete value of $t$ correspond to a unique non-overlapping 
generations of infected individuals, so that individuals infected at $t$ will have offspring at $t+1$, etc. 
Let $N_t$ denote the number of infectious individuals at time $t$. Each of them creates a number $s_{t,i}$ of secondary infections at time $t+1$, following the offspring distribution $\alpha_t(s)$. The mean of this distribution is the basic reproduction number $R_t$ and the variance is $V_t$. We have:

\begin{equation}
N_{t+1}=\sum_{i=1}^{N_t} s_{t,i}
\label{eq:summation}
\end{equation}

\subsection{Inclusive coalescence probability}

We define the inclusive coalescence probability $p_{k,t}(N_t, N_{t+1})$ as the probability that a specific set of $k$ individuals from generation $t+1$ find a common ancestor in generation $t$, conditional on population sizes $N_t$ and $N_{t+1}$.

Given full information about offspring counts from individuals in generation $t$, ${\bf s}_t = (s_{t,1}, \dots s_{t, N_t})$, we have

{\allowdisplaybreaks
	\begin{align}
		p_{k,t}({\bf s}_t, N_t)
			& = \sum_{i=1}^{N_t} \frac{\binom{s_{t,i}}{k}}{\binom{N_{t+1}}{k}} \nonumber\\
%			& = \sum_{i=1}^{N_t} \frac{s_{t,i}!}{(s_{t,i}-k)!} \frac{(N_{t+1}-k)!}{N_{t+1}!} \\
			& = \sum_{i=1}^{N_t} \frac{\Gamma(s_{t,i}+1) \Gamma(N_{t+1}-k+1)}{\Gamma(s_{t,i}-k+1) \Gamma(N_{t+1})}% \\
%			& = \sum_{i=1}^{N_t} \frac{s_{t,i} (s_{t,i} - 1) \dots (s_{t,i} - k + 1)}{N_{t+1} (N_{t+1} - 1) \dots (N_{t+1} - k+1)}.
	\end{align}
}

Full information $\{s_{t,i}\}$ yields the population size $N_{t+1}$ but is not feasible to observe in practice.
We can instead express the inclusive coalescence probability conditioning on the next population size $N_{t+1}$ by summing over possible offspring counts ${\bf s}_t = (s_{t,1}, \dots s_{t, N_t})$ conditional on the total generation size.
Let $S_t^{-(1)} = (S_{t,2}, \dots, S_{t, N_t})$.

{\allowdisplaybreaks
	\begin{align}
	p_{k,t}(N_t, N_{t+1})
%		& = \sum_{{\bf s}_t : \sum_{i=1}^{N_t} s_{i,t} = N_{t+1}} 
		& = \sum_{{\bf s}_t \in \mathbb{N}_0^{N_t}} \mathbb{P} \bigg[{\bf S}_t = {\bf s}_t \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg] p_{k,t}({\bf s}_t, N_t) \nonumber\\
%		& = \sum_{{\bf s}_t : \sum_{i=1}^{N_t} s_{i,t} = N_{t+1}} 
		& = \sum_{{\bf s}_t \in \mathbb{N}_0^{N_t}} \mathbb{P} \bigg[{\bf S}_t = {\bf s}_t \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg] \sum_{i=1}^{N_t} \frac{\binom{s_{t,i}}{k}}{\binom{N_{t+1}}{k}} \nonumber\\
%		& = \sum_{i=1}^{N_t} \sum_{{\bf s}_t : \sum_{i=1}^{N_t} s_{i,t} = N_{t+1}} 
		& = \sum_{i=1}^{N_t} \sum_{{\bf s}_t \in \mathbb{N}_0^{N_t}}\frac{\binom{s_{t,i}}{k}}{\binom{N_{t+1}}{k}} \mathbb{P} \bigg[S_{t,1} = s_{t,1}, {\bf S}_t^{-(1)} = {\bf s}_t^{-(1)} \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg] \nonumber\\
		& = \frac{N_t}{\binom{N_{t+1}}{k}} 
%		\sum_{{\bf s}_t : \sum_{i=1}^{N_t} s_{i,t} = N_{t+1}}
		\sum_{{\bf s}_t \in \mathbb{N}_0^{N_t}} \binom{s_{t,1}}{k} \mathbb{P} \bigg[S_{t,1} = s_{t,1} \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg] \nonumber \\
			& \phantom{=}\qquad \times \mathbb{P} \bigg[{\bf S}_t^{-(1)} = {\bf s}_t^{-(1)} \bigg| S_{t,1} = s_{t,1}, \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg] \nonumber\\
		& = \frac{N_t}{\binom{N_{t+1}}{k}} \sum_{s_{t,1} = 0}^{N_{t+1}} \binom{s_{t,1}}{k} \mathbb{P} \bigg[S_{t,1} = s_{t,1} \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg] \nonumber \\
			& \phantom{=}\qquad \times \underbrace{
				%\sum_{{\bf s}_t^{-(1)} : \sum_{i=2}^{N_t} s_{i,t} = N_{t+1} - s_{1,t}} 
				\sum_{{\bf s}_t^{-(1)} \in \mathbb{N}_0^{N_t - 1}} \mathbb{P} \bigg[{\bf S}_t^{-(1)} = {\bf s}_t^{-(1)} \bigg| \sum_{i=2}^{N_t} S_{t,i} = N_{t+1} - s_{1,t} \bigg]}_{=1} \nonumber\\
		& = \frac{N_t}{\binom{N_{t+1}}{k}} \mathbb{E}\bigg[ \binom{S_{t,1}}{k} \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg] \label{eq:GeneralInclusiveProb} %\nonumber\\
%		& = N_t \frac{(N_{t+1} - k)!}{N_{t+1}!} \mathbb{E} \bigg[ \frac{S_{t,1}!}{(S_{t,1} - k)!} \bigg | \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg]. \label{eq:GeneralInclusiveProb}
	\end{align}
}

The $k$-th falling factorial moments $\mathbb{E} \big[ \frac{S_{t,1}!}{(S_{t,1} - k)!} \big | \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \big]$ in Equation \eqref{eq:GeneralInclusiveProb} can be readily obtained by differentiating the probability generating function of $S_{t,1} | (\sum_{i=1}^{N_t} S_{t,i} = N_{t+1})$.

\subsection{Exclusive coalescence probability}

Generally, we observe a sample of individuals from each generation rather than the entire population.
In this case, we are interested in the exclusive coalescence probability $p_{n,k,t}(N_t, N_{t+1})$ that exactly $k$ individuals from a sample of $n$ arose from a common ancestor one generation in the past given knowlege of the total population sizes $N_t$ and $N_{t+1}$.

Given full information about offspring counts of the parents of sampled individuals at the present, ${\bf x}_t = (x_{t,1}, \dots, x_{t,N_t})$, we have
	\begin{align}
		p_{n,k,t}({\bf x}_t, N_t)
			& = \sum_{i=1}^{N_t} \frac{\binom{x_{t,i}}{k}}{\binom{n}{k}} \mathbb{I} \{ x_{t,i} = k \}\nonumber\\
			& = \sum_{i=1}^{N_t} \frac{x_{t,i}!}{(x_{t,i} - k)!} \frac{(n-k)!}{n!} \mathbb{I} \{ x_{t,i} = k \}
	\end{align}

Similarly to the exclusive coalescence probability, we can use this to evaluate the exclusive probability given $N_t$ and $N_{t+1}$ by summing over possible parent offspring configurations (for $k \leq n$),

	\begin{align}
		p_{n,k,t}(N_t, N_{t+1})
			& = \sum_{{\bf x}_t \in \mathbb{N}_0^{N_t}} \mathbb{P} \bigg[ {\bf X}_t = {\bf x}_t \bigg | \sum_{i=1}^{n} X_{t,i} = n \bigg] p_{n,k,t} ({\bf x}_t, N_t) \nonumber\\
			& = \sum_{{\bf x}_t \in \mathbb{N}_0^{N_t}} \mathbb{P} \bigg[ {\bf X}_t = {\bf x}_t \bigg | \sum_{i=1}^{n} X_{t,i} = n \bigg] \sum_{i=1}^{N_t} \frac{\binom{x_{t,i}}{k}}{\binom{n}{k}} \mathbb{I} \{ x_{t,i} = k \} \nonumber\\
			& = \frac{N_t}{\binom{n}{k}} \sum_{{\bf x}_t \in \mathbb{N}_0^{N_t}} \binom{x_{t,1}}{k} \mathbb{P} \bigg[ {\bf X}_t = {\bf x}_t \bigg| \sum_{i=1}^{N_t} X_{t,i} = n \bigg] \mathbb{I} \{x_{t,1} = k \} \nonumber\\
			& = \frac{N_t}{\binom{n}{k}}
%				\sum_{{\bf x}_t^{-(1)} : \sum_{i=2}^n x_{t,i} = n-k} 
				\sum_{{\bf x}_t^{-(1)} \in \mathbb{N}_0^{N_t - 1}} \binom{k}{k} \mathbb{P}\bigg[X_{t,1} = k, {\bf X}_t^{-(1)} = {\bf x}_t^{-(1)} \bigg| \sum_{i=1}^{N_t} X_{t,i} = n \bigg] \nonumber\\
			& = \frac{N_t}{\binom{n}{k}} \mathbb{P}[X_{t,1} = k \bigg| \sum_{i=1}^{N_t} X_{t,i} = n \bigg]
%				\sum_{{\bf x}_t^{-(1)} : \sum_{i=2}^n x_{t,i} = n-k} 
				\underbrace{\sum_{{\bf x}_t^{-(1)} \in \mathbb{N}_0^{N_t - 1}} \mathbb{P}\bigg[{\bf X}_t^{-(1)} = {\bf x}_t^{-(1)} \bigg| \sum_{i=1}^{N_t} X_{t,i} = n, X_{t,1} = k \bigg]}_{=1} \nonumber\\
			& = \frac{N_t}{\binom{n}{k}} \mathbb{P} \bigg[ X_{t,1} = k \bigg| \sum_{i=1}^{N_t} X_{i,t} = n \bigg] \label{eq:GeneralExclusiveProb}
	\end{align}

Note that $X_{t,i}$ does not follow the same offspring distribution as $S_{t,i}$.
$(X_{t,1}, \dots, X_{t, N_t})$ consists of $n$ individuals sampled from generation $t+1$ without replacement - there is no guarantee that all offspring from any given parent are included in the sample.

\subsection{Complementarity of exclusive coalescence probabilities}

If we consider one of the lines observed amongst a set of $n$, it can either remain uncoalesced
(with probability $p_{n,1,t}$) or coalesce in an event of size $k$ (with probability $p_{n,k,t}$) with any set of $k-1$ lines among the $n-1$ other lines, leading to the following complementarity equation: 

\begin{equation}
\sum_{k=1}^n \binom{n-1}{k-1} p_{n,k,t} =1
\end{equation}

We can show that it is indeed satisfied by the formula in Equation \eqref{eq:GeneralExclusiveProb}:

	\begin{align}
		\sum_{k=1}^n \binom{n-1}{k-1} p_{n,k,t}
			& = \sum_{k=1}^n \binom{n-1}{k-1} \frac{N_t}{\binom{n}{k}} \mathbb{P}\left[X_1 = k \bigg| \sum_{i=1}^{N_t} X_i = n\right] \nonumber\\
			& = \sum_{k=1}^n N_t \frac{k}{n} \mathbb{P}\left[X_1=k \bigg| \sum_{i=1}^{N_t} X_i = n\right] \nonumber\\
			& = \frac{N_t}{n} \sum_{k=0}^n k \mathbb{P}\left[X_1 = k \bigg| \sum_{i=1}^{N_t} X_i = n\right] 
			%\tag{lower limit $k=0$ makes no difference overall}
			\nonumber\\
			& = \frac{N_t}{n} \mathbb{E}\left[X_1 \bigg| \sum_{i=1}^{N_t} X_i = n \right] \nonumber\\
%			& = p_{1,t} (N_t, n) = 1 %\tag{see below}
%	\end{align*}
%	Taken from \href{https://math.stackexchange.com/questions/2508465/conditional-expectation-of-random-variable-given-a-sum}{stackexchange (link)}
%	\begin{align}
%		\mathbb{E}[X_1 | \sum_{i=1}^{N_t} X_i = n]
			& = \frac{1}{n} \sum_{i=1}^{N_t} \mathbb{E}\left[X_i \bigg| \sum_{i=1}^{N_t} X_i = n\right] %\tag{$X_i$ i.i.d.} 
			\nonumber\\
			& = \frac{1}{n} \mathbb{E}\left[ \sum_{i=1}^{N_t} X_i \bigg| \sum_{i=1}^{N_t} X_i = n\right] \nonumber\\%\tag{Swap expectation, sum \it (possibly questionable?)} \\
			& = 1%\frac{n}{N_t}
	\end{align}
	
\section{Poisson case}

Here the offspring distribution is $\alpha_t = \text{Poisson}(R_t)$.
In this case, we have 
	\begin{equation}
		\sum_{i=1}^{N_t} S_{t,i} \sim \text{Poisson}(N_t R_t)
	\end{equation}
and conditional distribution
{\allowdisplaybreaks
	\begin{align}
		\mathbb{P}\bigg[S_{t,1} = s \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg]
			& = \frac{\displaystyle\mathbb{P}\bigg[S_{t,1} = s, \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg]}{\displaystyle\mathbb{P}\bigg[\sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg]} \nonumber\\
			& = \frac{\displaystyle\alpha_t (s) \, \mathbb{P}\bigg[ \sum_{i=2}^{N_t} S_{t,i} = N_{t+1} - s \bigg]}{\displaystyle\mathbb{P}\bigg[\sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg]} \nonumber\\
			& = \frac{\displaystyle\frac{R_t^s e^{-R_t}}{s!} \cdot \frac{((N_t - 1)R_t)^{N_{t+1} - s}}{(N_{t+1} - s)!}}{\displaystyle\frac{(N_t R_t)^{N_{t+1}} e^{-N_t R_t}}{N_{t+1}!}} \nonumber\\
			& = \binom{N_{t+1}}{s} \left( \frac{1}{N_t} \right)^s \left( 1 - \frac{1}{N_t} \right)^{N_{t+1} - s}
	\end{align}
}

This is the probability mass function of a Binomial distribution and therefore we deduce that:
	\begin{equation}
		S_{t,1} \bigg| \left(\sum_{i=1}^{N_t} S_{t,i} = N_{t+1}\right) \sim \text{Binomial}\left(N_{t+1}, \frac{1}{N_t}\right)
	\end{equation}

The $k$-th falling factorial moments of $X \sim \mathrm{Binomial}(n,p)$ are
\citep{Potts1953}:

\begin{equation}
	\mathbb{E}\left[\frac{X!}{(X-k)!}\right]=\binom{n}{k} p^k k!
\end{equation}

By injecting this formula into Equation \eqref{eq:GeneralInclusiveProb} 
we obtain the inclusive probability of coalescence for $k$ lines:
\begin{equation}
	\mathbb{E} \left[ \binom{S_{t,1}}{k} \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \right]
		= \frac{1}{k!} \mathbb{E} \left[ \frac{S_{t,1}!}{(S_{t,1} - k)!} \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \right]
		= \frac{1}{k!} \, \frac{N_{t+1}!}{(N_{t+1} - k)!} \left( \frac{1}{N_t} \right)^k
\end{equation}

Consequently, the inclusive probability of coalescence for $k$ lines is
\begin{equation}
	p_{k,t}=\frac{1}{N_t^{k-1}}\label{eq:PoisInclusiveProb}
\end{equation}

By injecting the probability mass function of a Binomial distribution in Equation 
\eqref{eq:GeneralExclusiveProb} we deduce that 
the exclusive probability of coalescence for $k$ lines from a sample of $n$ $(n \geq k)$ is
	\begin{equation}
		p_{n,k,t} = \frac{(N_t-1)^{n-k}}{N_t^{n-1}}\label{eq:PoisExclusiveProb}
	\end{equation}
	
It is interesting to note that neither the inclusive nor the exclusive coalescence probability
depend on the mean $R_t$ of the Poisson offspring distribution or the size $N_{t+1}$
of the population at time $t+1$.
The inclusive coalescent probability in Equation \eqref{eq:PoisInclusiveProb}
can also be obtained conceptually by considering
that among the $k$ lines, the first one has an ancestor with probability one, 
and the remaining $k-1$ need to have the same ancestor among a set of $N_t$ from
which they choose uniformly at random so that the probability of picking the same ancestor
is $1/N_t$. The exclusive coalescent probability in Equation \eqref{eq:PoisExclusiveProb} 
can be derived likewise by considering
that in addition to the above, each of the $n-k$ other lines need to choose a different
ancestor, which happens with probability $(N_t-1)/N_t$.

Figure \ref{fig:pois} illustrates the inclusive and exclusive coalescence probabilities for
the Poisson case for a set of size $k=1$ to $k=10$ amongst a total of $n=10$ observed
lines, in a population of size $N_t=10$, $N_t=20$ or $N_t=30$. 

\begin{figure}[!p]
\begin{center}
\includegraphics[width=15cm]{../run/figurePois.pdf}
\end{center}
\caption{Inclusive and exclusive coalescence probabilities for the Poisson case.
\label{fig:pois}}
\end{figure}

\section{Negative-Binomial case}

Here the offspring distribution is $\alpha_t=\text{Negative-Binomial}(r,p)$ with parameters $(r,p)$ set my moment-matching mean $R_t$ and variance $V_t$.
The resulting parameters for this distribution are $r=R_t^2/(V_t-R_t)$ and $p=R_t/V_t$.
In this case, we have
	\begin{equation}
		\sum_{i=1}^{N_t} S_{t,i} \sim \text{Negative-Binomial}(N_t r,p)
	\end{equation}
and similarly to the Poisson$(\lambda)$ offspring distribution identify the conditional distribution of $S_{t,1} | \sum_{i=1}^{N_t} S_{t,i}$ as follows,

{\allowdisplaybreaks
	\begin{align}
		\mathbb{P}\bigg[ S_{t,1} = s \bigg| \sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg]
			& = \frac{\alpha_t(s) \cdot \mathbb{P} \bigg[\sum_{i=2}^{N_t} S_{t,i} = N_{t+1} - s \bigg]}{\mathbb{P}\bigg[\sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg]} \nonumber\\
			& = \frac{\displaystyle\frac{\Gamma(r+s)}{s! \Gamma(r)} (1-p)^s p^r \cdot \frac{\Gamma\big((N_t - 1)r+(N_{t+1} - s)\big)}{(N_{t+1} - s)! \Gamma((N_t - 1) r)} (1-p)^{N_{t+1} - s} p^{(N_t-1)r}}{\displaystyle\frac{\Gamma(N_tr+N_{t+1})}{N_{t+1}! \Gamma(N_t r)} (1-p)^{N_{t+1}} p^{N_t r}} \nonumber\\
			& = \frac{N_{t+1}!}{s! (N_{t+1} - s)!} \frac{\Gamma(r+s) \Gamma\big( (N_t - 1)r + (N_{t+1} - s) \big)}{\Gamma(N_t r + N_{t+1})} \frac{\Gamma(N_t r)}{\Gamma(r) \Gamma\big((N_t - 1)r \big)} \nonumber\\
			& = \binom{N_{t+1}}{s} \frac{\mathrm{B}(s + r, N_{t+1} - s + (N_t-1)r)}{\mathrm{B}(r, (N_t-1)r)}
	\end{align}
}

\noindent where  $\mathrm{B}(x,y)$ denotes the Beta function defined as $\mathrm{B}(x,y)=\Gamma(x)\Gamma(y)/\Gamma(x+y)$. This is the probability mass function of Beta-Binomial and therefore we deduce that:

\begin{equation}
S_{t,1} \bigg| \bigg(\sum_{i=1}^{N_t} S_{t,i} = N_{t+1} \bigg) \sim \text{Beta-Binomial}(r, (N_t - 1)r)
\end{equation}

The $k$-th falling factorial moments of $X \sim \text{Beta-Binomial}(\alpha,\beta)$ are \citep{Tripathi1994}:

\begin{equation}
	\mathbb{E}\left[\frac{X!}{(X-k)!}\right]=\binom{n}{k} \frac{\mathrm{B}(\alpha+k,\beta)k!}{\mathrm{B}(\alpha,\beta)}
\end{equation}

Injecting this formula into Equation \eqref{eq:GeneralInclusiveProb}, we deduce that the inclusive probability of coalescence for $k$ lines is:

\begin{equation}
p_{k,t}=
%\prod_{i=1}^{k-1}\frac{r+i}{N_t r+i}=
\frac{\mathrm{B}(N_t r+1,r+k)}{\mathrm{B}(r+1,N_t r+k)}
\label{eq:NegBinInclusiveProb}
\end{equation}

By injecting the probability mass function of a beta-binomial distribution in Equation 
\eqref{eq:GeneralExclusiveProb} we deduce that 
the exclusive probability of coalescence for $k$ lines is:

\begin{equation}
p_{n,k,t}=\frac{N_t \mathrm{B}(k+r, n-k+N_t r-r)}{\mathrm{B}(r, N_t r-r)}
\label{eq:NegBinExclusiveProb}
\end{equation}

It is interesting to note that as for the Poisson case, the inclusive and exclusive coalescence probabilities do not depend on the size $N_{t+1}$ of the population at time $t+1$.
They both depend on the 
Negative-Binomial offspring distribution only through the dispersion parameter $r$.

Figure \ref{fig:negbin} illustrates the inclusive and exclusive coalescence probabilities for
the Negative-Binomial case for a set of size $k=1$ to $k=10$ amongst a total of $n=10$
 observed lines, in a population of size $N_t=12$. 
Several Negative-Binomial offspring distributions are compared, 
all of which have the same mean $R_t=2$,
and with the dispersion parameter equal to $r=1$, $r=2$, $r=10$ and $r=100$.
When $r=1$ the Negative-Binomial reduces to a Geometric distribution.
When $r$ is high (for example $r=100$ as shown in Figure \ref{fig:negbin}) 
the dispersion is low and the Negative-Binomial case 
behaves almost like the Poisson case. When $r$ is lower the dispersion of the
offspring distribution increases, so that 
both the inclusive and exclusive probabilities of larger multimerger events increase.

\begin{figure}[!p]
\begin{center}
\includegraphics[width=15cm]{../run/figureNegBin.pdf}
\end{center}
\caption{(A) Offspring distribution. (B) Inclusive probability of coalescence. (C) Exclusive probability of coalescence.
\label{fig:negbin}}
\end{figure}

\section{Limit when the population size is large}

If we consider that the population size $N_t$ is fixed and large, we can show the connections
between our model and several previous studies.

Show that inclusive probabilities $p_{k,t}$ for $k>2$ are small compared to $p_{2,t}$.

Show that exclusive probabilities $p_{n,k,t}$ for $k>2$ are small compared to $p_{n,2,t}$, 
when $n<<N_t$.

Show that inclusive and exclusive probabilities become equal, when $n<<N_t$ in exclusive probabilities.

For Poisson offspring distribution we have:

\begin{equation}
p_{2,t}=p_{n,2,t}=\frac{1}{N_t}\label{eq:poissonapprox}
\end{equation}

For Negative-Binomial offspring distribution we have:

\begin{equation}
p_{2,t}=p_{n,2,t}=\frac{r+1}{N_t r +1} \approx \frac{r+1}{N_t r}\label{eq:negbinapprox}
\end{equation}

\citet{Fraser2017} calculated the effective population size $N_e(t)$ 
as a function of the actual population size $N(t)$ and the mean and variance of the offspring distribution $R$ and $\sigma^2$:
\begin{equation}
N_e(t)=\frac{N(t)}{\sigma^2/R+R-1}
\end{equation}

This formula was used to estimate the dispersion parameter from genetic data \citep{Li2017}.
In our notation, this is equivalent to:

\begin{equation}
 p_{2,t}=\frac{V_t/R_t+R_t-1}{N_t R_t}\label{eq:fraser}
 \end{equation}

In the Poisson case we have $V_t=R_t$ so that Equation \eqref{eq:fraser} simplifies to $p_{2,t}=1/N_t$ which agrees with Equation \eqref{eq:poissonapprox}. 
In the Negative-Binomial case we have $V_t/R_t=1/p=(r+R_t)/r$ so that Equation \eqref{eq:fraser}
simplifies to $(r+1)/(rN_t)$ which agrees with our Equation \eqref{eq:negbinapprox}. 
Conversely, if we substitute $r=R_t^2/(V_t-R_t)$
in Equation \eqref{eq:negbinapprox} we obtain the formula Equation \eqref{eq:fraser}.

\citet{koelleRatesCoalescenceCommon2012} derived the rates of coalescence of two lineages 
for several epidemiological models, assuming a large population at equilibrium.
For each model they use the equation $N_e=N/\sigma^2$ to relate the effective population
size $N_e$ to the actual population size $N$ and the variance $\sigma^2$ in the number
of offspring. This relationship was first established by \citet{Kingman1982} to
apply the coalescent model to Cannings exchangeable models \citep{Cannings1974}. 
From Equation \eqref{eq:negbinapprox} we can take $R_t=1$ to achieve 
equilibrium of the population size and $r=R_t^2/(V_t-R_t)=1/(V_t-1)$ to deduce 
the equivalent $p_{2,t}=V_t/N_t$. 

\citet{Volz2012a} showed that the rate of coalescence for two lineages under a continuous-time epidemic coalescent model is $2f(t)/I(t)^2$
 where $f(t)$ is the incidence and $I(t)$ the prevalence. 
 Setting in this formula the prevalence as $I(t)=N_{t+1}=N_t R_t$ and the incidence as
 $f(t)=R_t N_{t+1}=R_t^2 N_t$ we get a coalescent rate of 
 $2/N_t$. To apply the Equation \eqref{eq:negbinapprox} we need to set $r=1$ 
 so that the offspring distribution is Geometric, which yields the same result.

\section{Lambda-coalescent}

The coalescent model \citep{Kingman1982,Kingman1982a} describes the ancestry of a sample from a large population 
evolving according to many forward-in-time models such as the Wright-Fisher model \citep{Wright1931,Fisher1930}, 
the Moran model \citep{Moran1958} and the Cannings exchangeable model \citep{Cannings1974}.
Since the coalescent considers a large population in which each individual only has a number of offspring that is small
compared to the population size, coalescent trees are always binary and do not feature multimergers,
making them unsuitable to represent the ancestry of outbreaks considered in this study.
However, the lambda-coalescent models are an extension of the coalescent model that do
allow multimergers
\citep{pitmanCoalescentsMultipleCollisions1999,sagitovGeneralCoalescentAsynchronous1999,donnellyParticleRepresentationsMeasureValued1999}. 

A lambda-coalescent model is defined by a probability measure 
$\Lambda(\mathrm{d} x)$ on the interval $[0,1]$, from which we can deduce
the rate $\lambda_{n,k}$ at which any subset of $k$ lineages within a set of $n$ observed lineages 
coalesce:

\begin{equation}
    \lambda_{n,k} = \int_{0}^{1}{x^{k-2}(1-x)^{n-k}\,\Lambda(\mathrm{d} x)}\label{eq:lambda}
\end{equation}

The beta-coalescent \citep{schweinsbergCoalescentProcessesObtained2003} is a 
specific type of lambda-coalescent. 
Was used in \citep{Hoscheit2019} and \citep{Menardo2021}. 
David's paper on inference of multiple mergers while dating a pathogen phylogeny \citep{Helekal2024}.
The Beta$(2-\alpha,\alpha)$-coalescent model 
has a single parameter $\alpha \in [0,2]$ and is defined as:

\begin{equation}
\Lambda(\mathrm{d}x)=\frac{x^{1-\alpha}(1-x)^{\alpha-1}}{\mathrm{B}(2-\alpha,\alpha)}\mathrm{d}x
\label{eq:beta}
\end{equation}

By combining Equations \eqref{eq:lambda} and \eqref{eq:beta} we can deduce that:

\begin{equation}
\lambda_{n,k}=\frac{\mathrm{B}(k-\alpha,n-k+\alpha)}{\mathrm{B}(2-\alpha,\alpha)}
\end{equation}

Special cases of the beta-coalescent 
include $\alpha=2$ corresponding to the Kingman coalescent,
$\alpha=1$ which is known as the Bolthausen-Sznitman coalescent
and $\alpha=0$ for which the phylogeny is always star-shaped.

We now define our own lambda-coalescent based on the Negative-Binomial case described previously.
For ease of comparison with other coalescent models, we consider that time is continuous
and that the population size remains constant equal to $N_t$. 
The exclusive coalescent probability $p_{n,k,t}$ in the Negative-Binomial case 
given by Equation \eqref{eq:NegBinExclusiveProb} can be used to determine the corresponding 
rate of our lambda-coalescent, if we consider that the probability of each event in discrete time
is the result of the event happening at a constant rate in continuous time: 
\begin{equation}
\lambda_{n,k}=-\mathrm{log}(1-p_{n,k,t})
\label{eq:ours}
\end{equation}

In order to compare our lambda-coalescent with other models, we consider 
the distribution of the size $k$ of the next event among
a set of $n$ lineages. For any lambda-coalescent this can be computed as:

\begin{equation}
p(k|n)=\frac{\binom{n}{k}\lambda_{n,k}}{\sum_{i=2}^n \binom{n}{i}\lambda_{n,i}}
\end{equation}

Figure \ref{fig:compare} compares this distribution for $n=10$ in the Beta-coalescent with 
parameter $\alpha \in \{0.5,1,1.5\}$ and for our lambda-coalescent with parameters
$N_t \in \{15,25,50\}$ and $r \in \{0.1,0.5,1\}$.

\begin{figure}[!p]
\begin{center}
\includegraphics[width=15cm]{../run/figureCompare.pdf}
\end{center}
\caption{Distribution of the size of the next event among a set of $n=10$ lineages, 
compared between the Beta-coalescent and our lambda-coalescent model 
with various parameters.
\label{fig:compare}}
\end{figure}

Genealogies can be simulation from our lambda-coalescent model 
defined in Equation \ref{eq:ours} using the same algorithm
as for other lambda-coalescent models \citep{pitmanCoalescentsMultipleCollisions1999}.
Figure \ref{fig:trees} shows examples of trees simulated for a sample of size $n=20$ and
with constant population size $N_t=40$. 

\begin{figure}[!p]
\begin{center}
\includegraphics[width=15cm]{../run/figureTree.pdf}
\end{center}
\caption{Example of trees simulated under our lambda-coalescent with $r=0.1$ (A),
$r=1$ (B), $r=5$ (C) and $r=10$ (D).
\label{fig:trees}}
\end{figure}

Figure \ref{fig:stats} shows summary statistics for 10,000 trees simulated in the same conditions
as the individual trees shown in Figure \ref{fig:trees}. 
As the dispersion parameter increases from $r=0.1$
to $r=10$ multimerger events become less and less likely and large. Simultaneously, the
time to the most recent common ancestor increases, as well as the stemminess of the tree 
(ie the proportion of branch lengths in non-terminal branches).

\begin{figure}[!p]
\begin{center}
\includegraphics[width=15cm]{../run/figureStats.pdf}
\end{center}
\caption{Summary statistics for trees simulated under our lambda-coalescent with $r=0.1$, $r=1$, $r=5$ and $r=10$, namely the time to the most recent common ancestor (A), stemminess (B), number of multimergers (C) and the size of the largest multimerger (D).
\label{fig:stats}}
\end{figure}

\section{Parameter inference}

Consider a genealogy $T$ with $n$ leaves and $c$ coalescent nodes, with $t_0=0$ the
sampling time,
$t_1,...,t_c$ the times of the coalescent nodes in increasing order and $k_i$ the number
of lineages coalescing at time $t_i$. The number of lineages existing between
time $t_{i-1}$ and $t_i$ is then $n_i=n-\sum_{j=1}^{i-1} k_j$.
Under a lambda-coalescent model, the genealogy $T$ has likelihood:

\begin{equation}
p(T|\Lambda)=\prod_{i=1}^{c}\binom{n_i}{k_i}\lambda_{n_i,k_i}\exp\left(-\sum_{j=2}^{n_i}\binom{n_i}{j}\lambda_{n_i,j}(t_i-t_{i-1})\right)
\label{eq:likelihood}
\end{equation}

Estimating the lambda measure in general is a difficult problem
\citep{Koskela2018a,miropinaEstimatingLambdaMeasure2023}.
Here however we focus on estimation under our lambda-coalescent model,
where the $\lambda_{n,k}$ terms are given by Equation \eqref{eq:ours}.
There are therefore two parameters to estimate which have direct and important 
biological meaning:
the effective population size $N_t$ (which remains constant) and the dispersion
parameter $r$ of the Negative-Binomial offspring distribution. 
We perform estimation simply by maximising the likelihood in Equation \eqref{eq:likelihood},
using the Brent algorithm \citep{brent1971algorithm} when estimating a single parameter
and the L-BFGS-B algorithm when \citep{byrd1995limited} estimating both parameters.

\begin{figure}[!p]
\begin{center}
\includegraphics[width=15cm]{../run/figureEstim.pdf}
\end{center}
\caption{Maximum likelihood estimation of parameters
\label{fig:estim}}
\end{figure}

We simulated 100 genealogies from our lambda-coalescent model each of which had
$n=100$ leaves, with parameter $N_e$ drawn uniformly at random between 100 and 500
and parameter $r$ drawn uniformly at random between 0.01 and 2.
If we assume knowledge of the dispersion parameter, then estimating the population size 
works really well (Figure \ref{fig:estim}A). Conversely we obtain good result when 
estimating the dispersion parameter given a known population size 
(Figure \ref{fig:estim}B). However, attempting to estimate both parameters at the same
time performed significantly less well (Figures \ref{fig:estim}C and D). 
To illustrate the cause of this, we consider a simulation for which the true $N_t$ was 200
and the true $r$ was 0.5, and we construct the likelihood surface (Figure \ref{fig:estim}E).
This shows a strong inverse tradeoff between the two parameters, which explains why
one can be estimated given the other, but not jointly.

\section{Implementation}

We implemented the analytical methods described in this paper in a 
new R package entitled \emph{EpiLambda} which is available
at \url{https://github.com/xavierdidelot/EpiLambda} for R version 3.5 or later. 
All code and data needed to replicate the results are included in the ``run'' directory of the \emph{EpiLambda} repository.
The R package \verb+ape+ was used to store, manipulate and visualise phylogenetic trees
\citep{Paradis2019}.

\section{Discussion}

Our lambda-coalescent could be defined in a varying population size 
following the same approach as previously described for
the coalescent \citep{Griffiths1994} and the beta-coalescent \citep{Hoscheit2019}.
Could also extend to temporally offset leaves 
following work on the coalescent \citep{Drummond2003} and the beta-coalescent
\citep{Hoscheit2019}.

The Xi-coalescent models admit multiple 
simultaneous mergers \citep{schweinsbergCoalescentsSimultaneousMultiple2000}.

Difference between transmission tree and phylogenetic tree \citep{Jombart2011}. 
Modelling within-host evolution to bridge the gap \citep{Didelot2014,Hall2015,Didelot2017}.
Superspreading individuals vs superspreading events \citep{Riley2003,Wallinga2004,hoAccountingPotentialOverdispersion2023}.

\section*{Acknowledgements}

We acknowledge funding from the National Institute for Health Research (NIHR) Health Protection Research Unit in Genomics and Enabling Data.

\clearpage
\bibliographystyle{elsarticle-harv}
%\bibliography{biblio,/Users/u1775021/all.bib}
\bibliography{biblio}

\end{document}

